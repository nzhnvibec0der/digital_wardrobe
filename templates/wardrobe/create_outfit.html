{% extends "base.html" %}
{% block title %}–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑{% endblock %}
{% load static %}

{% block content %}
<h1 class="text-3xl font-bold text-purple-700 mb-6 text-center md:text-left">üëó –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑</h1>

<form method="POST" id="outfit-form">
    {% csrf_token %}
    <input type="hidden" name="items" id="selected-items">

    <div class="flex flex-col md:flex-row gap-6">

        <!-- üîπ –°–ø–∏—Å–æ–∫ –≤–µ—â–µ–π -->
        <div class="w-full md:w-[40%] bg-white rounded-2xl shadow p-4 overflow-y-auto max-h-[700px]">
            <h2 class="text-lg font-semibold text-purple-700 mb-3">–ú–æ–∏ –≤–µ—â–∏</h2>
            <div id="item-list" class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-3 gap-3">
                {% for item in items %}
                <div class="border rounded-xl overflow-hidden shadow-sm cursor-pointer hover:shadow-md transition"
                     draggable="true"
                     data-item-id="{{ item.id }}">
                    <img src="{{ item.image.url }}" alt="{{ item.name }}" class="w-full h-28 object-contain bg-gray-50">
                    <p class="text-center text-sm text-gray-600 p-1 truncate">{{ item.name }}</p>
                </div>
                {% empty %}
                <p class="text-gray-500 col-span-full text-center py-6">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤–µ—â–µ–π üòî</p>
                {% endfor %}
            </div>
        </div>

        <!-- üîπ –•–æ–ª—Å—Ç -->
        <div class="relative w-full md:w-[360px] bg-white border border-gray-300 rounded-xl shadow-inner overflow-hidden mx-auto"
             style="height: 600px;" id="canvas">
            <p id="canvas-hint"
               class="absolute inset-0 flex items-center justify-center text-gray-400 text-center pointer-events-none">
               –ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –Ω–∞–∂–º–∏ –Ω–∞ –≤–µ—â—å
            </p>
        </div>
    </div>

    <!-- üîπ –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex gap-3">
            <button type="button" id="clear-canvas"
                    class="px-5 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                üóë –û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç
            </button>
            <button type="submit"
                    class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑
            </button>
        </div>
        <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞"
               class="w-full md:w-1/3 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-400 outline-none">
    </div>
</form>

<!-- üîπ JS: Drag & Touch -->
<script>
const items = document.querySelectorAll('[data-item-id]');
const canvas = document.getElementById('canvas');
const selectedInput = document.getElementById('selected-items');
const clearBtn = document.getElementById('clear-canvas');
const hint = document.getElementById('canvas-hint');
const selectedItems = new Set();

// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ (–ü–ö: drag, –º–æ–±: tap) ---
items.forEach(item => {
    // –ü–ö ‚Äî drag
    item.addEventListener('dragstart', e => {
        e.dataTransfer.setData('item-id', item.dataset.itemId);
    });

    // –º–æ–±–∏–ª–∫–∏ ‚Äî –ø–æ –∫–ª–∏–∫—É –¥–æ–±–∞–≤–ª—è–µ–º
    item.addEventListener('click', () => {
        const rect = canvas.getBoundingClientRect();
        addItemToCanvas(item.dataset.itemId, rect.width / 2 - 50, rect.height / 2 - 50);
    });
});

// --- drop –¥–ª—è –ü–ö ---
canvas.addEventListener('dragover', e => e.preventDefault());
canvas.addEventListener('drop', e => {
    e.preventDefault();
    const id = e.dataTransfer.getData('item-id');
    addItemToCanvas(id, e.offsetX - 40, e.offsetY - 40);
});

// --- —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ ---
function addItemToCanvas(itemId, x, y) {
    if (!selectedItems.has(itemId)) {
        hint.style.display = 'none';
        selectedItems.add(itemId);
        const src = document.querySelector(`[data-item-id="${itemId}"] img`).src;
        const img = document.createElement('img');
        img.src = src;
        img.className = 'absolute w-32 h-32 object-contain cursor-move select-none transition-all duration-100';
        img.style.left = x + 'px';
        img.style.top = y + 'px';
        img.draggable = false;

        // --- –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ (–º—ã—à—å + –ø–∞–ª–µ—Ü) ---
        let offsetX, offsetY, moving = false;

        img.addEventListener('mousedown', e => {
            moving = true;
            offsetX = e.offsetX;
            offsetY = e.offsetY;
            img.style.zIndex = 10;
        });
        document.addEventListener('mouseup', () => moving = false);
        document.addEventListener('mousemove', e => {
            if (!moving) return;
            const rect = canvas.getBoundingClientRect();
            let newX = e.clientX - rect.left - offsetX;
            let newY = e.clientY - rect.top - offsetY;
            // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–º–∫–∞–º–∏
            newX = Math.max(0, Math.min(newX, rect.width - img.offsetWidth));
            newY = Math.max(0, Math.min(newY, rect.height - img.offsetHeight));
            img.style.left = newX + 'px';
            img.style.top = newY + 'px';
        });

        // --- touch –¥–ª—è –º–æ–±–∏–ª–æ–∫ ---
        img.addEventListener('touchstart', e => {
            moving = true;
            const touch = e.touches[0];
            const rect = img.getBoundingClientRect();
            offsetX = touch.clientX - rect.left;
            offsetY = touch.clientY - rect.top;
        }, { passive: false });

        img.addEventListener('touchmove', e => {
            if (!moving) return;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            let newX = touch.clientX - rect.left - offsetX;
            let newY = touch.clientY - rect.top - offsetY;
            // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–º–∫–∞–º–∏
            newX = Math.max(0, Math.min(newX, rect.width - img.offsetWidth));
            newY = Math.max(0, Math.min(newY, rect.height - img.offsetHeight));
            img.style.left = newX + 'px';
            img.style.top = newY + 'px';
            e.preventDefault();
        }, { passive: false });

        img.addEventListener('touchend', () => moving = false);

        // --- —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É ---
        img.addEventListener('dblclick', () => {
            canvas.removeChild(img);
            selectedItems.delete(itemId);
            if (selectedItems.size === 0) hint.style.display = 'flex';
            selectedInput.value = Array.from(selectedItems).join(',');
        });

        canvas.appendChild(img);
        selectedInput.value = Array.from(selectedItems).join(',');
    }
}

// üóë –û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç
clearBtn.addEventListener('click', () => {
    canvas.innerHTML = '';
    selectedItems.clear();
    selectedInput.value = '';
    hint.style.display = 'flex';
});
</script>
{% endblock %}

